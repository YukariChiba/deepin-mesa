From d868c155b73829d54a36c6c03becae15e63b925a Mon Sep 17 00:00:00 2001
From: wolfsunyu <wolfsunyu@zhaoxin.com>
Date: Mon, 29 Oct 2018 10:02:07 +0800
Subject: [PATCH] add zx's driver to mesa's driver map list and export a
 function to print mesa's driver map list

Change-Id: I7d2e99d7ccc7263b2294b9d64ea4d954698a3b35
---
 include/pci_ids/zx_pci_ids.h   |  2 ++
 src/loader/loader.c            | 14 ++++++++++++++
 src/loader/pci_id_driver_map.h |  7 +++++++
 3 files changed, 23 insertions(+)
 create mode 100644 include/pci_ids/zx_pci_ids.h

diff --git a/include/pci_ids/zx_pci_ids.h b/include/pci_ids/zx_pci_ids.h
new file mode 100644
index 00000000000..ca02a64ad45
--- /dev/null
+++ mesa-23.1.2/include/pci_ids/zx_pci_ids.h
@@ -0,0 +1,2 @@
+CHIPSET(0x3A03, Exc)
+CHIPSET(0x3A04, Exc)
--- mesa-23.1.2.orig/src/loader/loader.c
+++ mesa-23.1.2/src/loader/loader.c
@@ -70,6 +70,8 @@
 #define PATH_MAX 4096
 #endif
 
+__attribute__((visibility("default"))) void zx_print_driver_map_list(void);
+
 static void default_logger(int level, const char *fmt, ...)
 {
    if (level <= _LOADER_WARNING) {
@@ -80,6 +82,18 @@ static void default_logger(int level, co
    }
 }
 
+void zx_print_driver_map_list(void)
+{
+   int i=0;
+
+   printf("os mesa driver map list:\n");
+   while(driver_map[i].driver)
+   {
+       printf("vendor_id: %x, driver: %s\n", driver_map[i].vendor_id, driver_map[i].driver);
+       i;
+   }
+}
+
 static loader_logger *log_ = default_logger;
 
 int
--- mesa-23.1.2.orig/src/loader/pci_id_driver_map.h
+++ mesa-23.1.2/src/loader/pci_id_driver_map.h
@@ -44,6 +44,12 @@ static const int vmwgfx_chip_ids[] = {
 #undef CHIPSET
 };
 
+static const int zx_chip_ids[] = {
+#define CHIPSET(chip, family) chip,
+#include "pci_ids/zx_pci_ids.h"
+#undef CHIPSET
+};
+
 bool iris_predicate(int fd);
 
 static const struct {
@@ -62,6 +68,7 @@ static const struct {
    { 0x10de, "nouveau", NULL, -1, },
    { 0x1af4, "virtio_gpu", virtio_gpu_chip_ids, ARRAY_SIZE(virtio_gpu_chip_ids) },
    { 0x15ad, "vmwgfx", vmwgfx_chip_ids, ARRAY_SIZE(vmwgfx_chip_ids) },
+   { 0x1d17, "zx", zx_chip_ids, ARRAY_SIZE(zx_chip_ids), },
 };
 
 #endif /* _PCI_ID_DRIVER_MAP_H_ */

